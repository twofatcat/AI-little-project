# 股票小时级数据抓取项目 — 汇报

**汇报对象**：非技术上级  
**原则**：结论先行，自上而下，简洁可执行  

---

## 一、结论（30 秒版）

我们完成了一套**中美股票小时级数据的自动抓取与存储系统**，用于后续量化/时序训练；过程中发现并修复了**中国数据抓取不完整**的问题，并做了**基础清洗与质量检查**。在此基础上已升级为**工业级清洗管线**：引入交易所日历（含早收/午休/DST）、网格对齐、缺失占位打标、复权因子融合、异常打标与隔离、以及训练/标签可用性 mask，产出可直接用于训练的「干净表」。当前**运行方式与检查方式已整理成命令清单**，日常使用按清单操作即可。

---

## 二、核心结论展开（金字塔第二层）

### 1. 交付了什么

| 交付物 | 说明 |
|--------|------|
| **自动化抓取脚本** | 按配置列表自动拉取美国、中国 A 股的小时 K 线数据，支持“断点续跑”（从上次进度拉到最新）。 |
| **按季度分表存储** | 数据按市场（美/中）和季度存入轻量数据库；除原始表与 v1 清洗表外，新增 v2 规范表与 Gold 干净表，便于审计与训练。 |
| **开放选股接口** | 当前使用固定 20+20 只（AI/机器人产业链）；接口已预留，后续可改为由 LLM 或其它系统提供股票列表。 |
| **工业级清洗管线** | 交易日历对齐（美股最后半小时/早收日正确）、网格缺失占位与打标、复权因子表、跳变/异常打标与隔离、feature_mask 与 label_mask，输出可直接用于训练的干净表。 |

**一句话**：实现了“选股 → 抓取 → 多层级落库（raw / v1 / v2 / Gold）”的完整流水线，并为训练提供可追溯、可对齐、可 mask 的干净数据。

---

### 2. 遇到什么问题、怎么解决的

| 问题 | 原因（简要） | 解决方式 |
|------|----------------|----------|
| **中国数据明显少于美国** | 数据源对请求频率有限制，部分请求被限流或返回空。 | 降低请求频率、增加重试与退避、并为中国增加备用数据源；修复中国时区处理，避免时间窗口被截断。 |
| **数据“不干净”、不便做训练** | 时间格式不统一、缺少统一时间索引；美股最后半小时/早收日未按日历处理。 | 增加基础清洗（v1）；再升级为工业级管线：交易日历、v2 规范（打标不删行）、Gold 网格对齐、缺失占位、复权因子、异常隔离与 mask。 |
| **运行报错**（如 `Series` 无 `view` 属性） | 使用了仅在部分环境可用的写法。 | 改为通用写法（用 `astype` 替代 `view`），保证在当前 Python/pandas 环境下可运行。 |

**一句话**：通过限流与重试、备用源、时区与清洗规范解决了“中国数据少”和“数据不规范”；通过日历与网格、打标与 mask 达到工业级可训练标准。

---

### 3. 当前数据与流程达到什么标准

- **多轨存储**：原始表（`ohlcv_*`）、v1 清洗表（`bars_hourly_*`）、v2 规范表（`bars_hourly_v2_*`）、Gold 干净表（`bars_hourly_clean_*`）并存，便于对比、审计与训练。  
- **统一规范**：v1/v2 均以 bar 结束时刻的 UTC 秒数为主键，含本地时间、交易所时区；v2 额外按**交易所日历**对齐 bucket（早收/午休/DST 正确），异常打标不删行。  
- **可训练干净表**：Gold 表网格完整、缺失占位打标、复权价与 mask（feature_mask、label_mask_1/4/7），异常 bar 隔离（NULL + mask=0），可直接用于模型训练。  
- **可检查**：质量报告按**交易日历**计算每天预期 bar 数（非固定 4/7），并支持 v1/v2/clean 表；Gold 表另有缺失占位统计。  
- **可迁移**：提供 `migrate_ohlcv_to_bars.py`（转 v1）与 `migrate_to_v2_clean.py`（从 raw 重建 v2 + Gold），无需重新抓取即可补齐工业级表。

**一句话**：数据具备“可追溯、可对齐、可检查、可迁移、可训练”的特性，满足工程级与工业级使用需求。

---

### 4. 上级/同事如何“用”和“查”

- **日常使用**：所有终端命令已整理在 **`终端脚本命令.md`**（或项目内 `COMMANDS.md`），按“安装依赖 → 抓取 → 查看数据 → 质量报告”执行即可；也可只抓美国或只抓中国。  
- **查看数据**：通过 `view_data.py` 可总览、按股票或按表（含 v2、clean 表）抽样查看。  
- **检查质量**：运行 `quality_report.py` 查看各表行数、覆盖股票数、按日历的异常天数及（对 Gold）缺失占位统计。  
- **补齐工业级表**：若已有 `ohlcv_*`，可运行 `migrate_to_v2_clean.py` 生成 v2 与 Gold 表，可选 `--verify` 做抽样校验。

**一句话**：按 `终端脚本命令.md` 的步骤即可完成抓取、查看、质量检查与 v2/Gold 迁移。

---

## 三、关键产出清单（便于归档与交接）

| 类型 | 名称 | 用途 |
|------|------|------|
| 配置 | `config.py` | 数据库路径、市场列表、抓取间隔与重试；v2/Gold 开关、复权与异常阈值等。 |
| 选股 | `symbols.py` | 当前美/中各 20 只股票列表；可改为调用 LLM 等接口。 |
| 抓取入口 | `main.py` | 按进度抓取 → 写 raw（可选）→ v1 清洗 → v2 规范（可选）→ Gold 干净表（可选）。 |
| 清洗 v1 | `cleaning.py` | 统一时间索引、时区、OHLCV；v1 输出 `bars_hourly_*`；含 `canonicalize_hourly_bars_v2` 供 v2 使用。 |
| 交易日历 | `trading_calendar.py` | 交易所日历（XNYS/XSHG）、intraday bucket 生成（早收/午休/DST）；v2/Gold 依赖。 |
| 工业级管线 | `clean_pipeline.py` | 网格对齐、缺失占位打标、复权融合、异常检测与隔离、feature/label mask，产出 Gold 表。 |
| 复权因子 | `corp_actions.py` | US 日频 AdjClose/Close 算因子；CN 可选双抓算因子；与 `adj_factors_daily_*` 表配合。 |
| 存储 | `db/schema.py`, `db/storage.py` | 表结构及写入：ohlcv、bars_hourly、bars_hourly_v2、bars_hourly_clean、adj_factors_daily。 |
| 数据源 | `sources/us_yfinance.py`, `sources/cn_akshare.py` | 美国（yfinance）、中国（东财 + 新浪备用）小时数据拉取。 |
| 查看 | `view_data.py` | 总览、按股票/按表抽样（含 v2、clean 表）。 |
| 质量 | `quality_report.py` | 按交易日历的预期 bar 数、异常天数、缺失占位（Gold）等统计。 |
| 迁移 v1 | `migrate_ohlcv_to_bars.py` | 将 ohlcv_* 转为 v1 清洗表 bars_hourly_*。 |
| 迁移 v2+Gold | `migrate_to_v2_clean.py` | 从 ohlcv_* 重建 bars_hourly_v2_* 与 bars_hourly_clean_*，支持 `--verify`。 |
| 使用说明 | `终端脚本命令.md` / `COMMANDS.md` | 终端命令速查（安装、抓取、查看、质量、迁移）。 |

---

## 四、建议的后续动作（可选）

1. **定期运行**：按需（如每日或每周）执行 `python main.py`，使 raw / v1 / v2 / Gold 持续更新。  
2. **抽检质量**：定期运行 `python quality_report.py`，关注按日历的异常天数及 Gold 缺失占位。  
3. **扩展选股**：若接入 LLM 选股，只需在 `symbols.py` 改为调用外部接口，其余流程不变。  
4. **训练使用**：直接读 `bars_hourly_clean_*`，按 `feature_mask` / `label_mask_*` 过滤可用样本与标签。

---

**汇报整理说明**：本汇报在原有抓取与基础清洗基础上，纳入工业级清洗改造（交易日历、v2/Gold、复权、异常与 mask），采用金字塔原则：结论与核心信息在前，细节与清单在后，便于上级快速把握结果与用法。
