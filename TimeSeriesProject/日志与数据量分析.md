# 终端日志与数据量分析

基于 `main.py` 运行日志与 `view_data.py` / 数据库查询结果整理。

---

## 一、结论（是否正常）

- **美国数据**：正常。20 只股票、每只约 129～140 根小时 K 线，覆盖 2025Q4 与 2026Q1，无重试即成功。
- **中国数据**：结果正常，但过程有告警。20 只股票最终每只约 82～84 根小时 K 线，数据完整；但每只股票前 3 次请求均为“空”，第 4 次（备用源）才返回数据，说明主源被限流，备用源兜底成功。
- **数据量级**：与“交易日 × 每日小时 bar 数”相符，未见明显缺表、缺股票或时间断档。

**说明**：每日 bar 数现已由**交易所日历**决定（见 `quality_report.py`），不再使用固定 4/7；早收日、节假日会得到正确预期，v2/Gold 表按日历网格对齐。

---

## 二、终端日志分析（main.py）

### 1. 美国（US）

| 现象 | 说明 |
|------|------|
| 20 只股票均一次成功 | 无 `empty/no data`，无重试。 |
| 每只 raw=269, cleaned_saved=269 | 拉取 269 根 bar，v1 清洗后 269 根全部入库，无剔除。 |
| 耗时约 1 秒/只 | 请求间隔 0.4 秒 + 网络，整体正常。 |

若已开启 v2/Gold，日志还会出现 `v2_saved=…`、`gold_saved=…`；若未安装 `exchange_calendars`，会打印 `v2/gold skipped` 告警，v1 仍正常。

**结论**：美股数据源稳定，当前配置无需调整。

---

### 2. 中国（CN）

| 现象 | 说明 |
|------|------|
| 每只股票先出现 3 次 `empty/no data (attempt 1/3, 2/3, 3/3)` | 主源（东财）连续 3 次返回空，触发重试逻辑。 |
| 随后出现 `raw=248 cleaned_saved=244` | 第 4 次请求（备用源新浪）返回 248 根 bar；v1 清洗后 244 根入库，4 根因校验（如价格/高低约束）被剔除。 |
| 20 只全部最终成功 | 无“最终仍无数据”的股票，备用源兜底有效。 |
| 单只耗时约 30 秒～1 分钟 | 3 次重试 × 退避等待 + 第 4 次请求，耗时可接受但偏长。 |

**结论**：中国主源限流明显，当前通过“重试 + 备用源”保证了数据完整；若希望减少告警或提速，可在 `config.py` 中将 `FETCH_DELAY_SECONDS_CN` 调大（如 3～5 秒）或后续改用更稳定数据源。

---

### 3. 其他

- **pkg_resources 警告**：来自依赖库（如 py_mini_racer），与抓取逻辑无关，可忽略或后续升级 setuptools/对应库消除。
- **v2/Gold 依赖**：若未安装 `exchange_calendars`，main 会跳过 v2/Gold 写入并打日志，不影响 raw 与 v1 表。

---

## 三、数据量分析（view_data + 库内统计）

### 1. 表级汇总（示例）

| 表名 | 行数 | 说明 |
|------|------|------|
| ohlcv_us_2025Q4 | 2,580 | 20 只 × 约 129 根/只，覆盖 12 月 |
| ohlcv_us_2026Q1 | 2,800 | 20 只 × 140 根/只，覆盖 1 月 |
| ohlcv_cn_2025Q4 | 3,280 | 20 只 × 约 164 根/只，覆盖 11 月下旬～12 月 |
| ohlcv_cn_2026Q1 | 1,680 | 20 只 × 84 根/只，覆盖 1 月上旬～2 月初 |
| bars_hourly_* | （同上或略少） | v1 清洗表，异常行被剔除 |
| bars_hourly_v2_* | （与 v1 同量级） | v2 规范表，异常打标不删行 |
| bars_hourly_clean_* | （≥ v2，含缺失占位） | Gold 表，网格完整、含 mask |
| **合计** | 视表类型而定 | 与 view_data 一致 |

---

### 2. 是否与“交易日 × 每日 bar 数”一致

- **美国**  
  - 常规日约 7 根小时 bar/日（RTH 9:30–16:00）；早收日更少。  
  - 2026Q1：140 根/只 ÷ 7 ≈ 20 个交易日，**合理**。  
  - 具体每日预期由 **交易所日历**（`trading_calendar` / `quality_report.py`）计算，不再使用固定 7。

- **中国**  
  - 4 根小时 bar/日（10:30 / 11:30 / 14:00 / 15:00）。  
  - 2026Q1：84 根/只 ÷ 4 = 21 个交易日，**合理**。  
  - 每日预期同样由交易所日历计算，节假日、特殊日正确。

**结论**：数据量级与“按交易日、按日 bar 数”的预期一致；质量报告按日历校验，v2/Gold 表按日历网格对齐。

---

### 3. v1 清洗表与 raw 表差异

- **ohlcv_cn_2026Q1**：1,680 行（raw）  
- **bars_hourly_cn_2026Q1**：1,600 行（v1 清洗后）  
- 差 80 行 ≈ 20 只 × 4 根/只，与日志“raw=248, cleaned_saved=244”（每只少 4 根）一致，属 v1 清洗时按规则剔除异常 bar，**属预期行为**。

v2 表保留这些 bar 但打 QC 标志；Gold 表在网格上缺失占位、异常隔离并输出 mask，便于训练时显式过滤。

---

### 4. 与工业级清洗的关系

- **v2 表**（`bars_hourly_v2_*`）：与 v1 同源数据，但 bar 的起止时间按**交易所日历**对齐（美股最后半小时、早收日正确），异常不打删行而打 `flag_*`。
- **Gold 表**（`bars_hourly_clean_*`）：在 v2 基础上做**网格对齐**、缺失占位与打标（is_missing、suspected_halt 等）、复权价、跳变/异常打标与隔离、`feature_mask` 与 `label_mask_1/4/7`，可直接用于训练。
- **复权因子表**（`adj_factors_daily_{market}`）：US 默认用 yfinance 日频算；Gold 表用其生成 `*_adj` 与复权相关逻辑。

---

## 四、建议（可选）

1. **中国主源限流**：若希望减少“empty/no data”告警或提高主源成功率，可在 `config.py` 中将 `FETCH_DELAY_SECONDS_CN` 调大（如 3～5 秒）再观察。  
2. **数据量**：当前 US/CN 表级与每只股票 bar 数均正常，可按现有节奏继续增量抓取与质量报告。  
3. **pkg_resources**：属依赖告警，不影响数据正确性，可择机升级环境或依赖。  
4. **v2/Gold**：训练推荐使用 `bars_hourly_clean_*`，并按 `feature_mask` / `label_mask_*` 选取样本；历史仅有 raw 时可运行 `migrate_to_v2_clean.py` 补齐。

---

*分析依据：终端日志、view_data 输出及 `data/stocks.db` 表级与每 symbol 统计；质量报告逻辑见 `quality_report.py` 与 `trading_calendar.py`。*
