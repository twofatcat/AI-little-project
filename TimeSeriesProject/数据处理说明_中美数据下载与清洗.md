# 中美股票数据：下载后的数据处理说明

本文档说明本项目在**下载中美市场小时 K 线数据之后**所做的全部数据处理步骤，包括**基础清洗（v1）**与**工业级清洗（v2 + Gold）**，以及各步的原理与目的。

---

## 一、整体流程概览

```
下载（US: yfinance / CN: akshare 东财或新浪）
        ↓
  [可选] 写入原始表 ohlcv_{market}_{year}Q{q}
        ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │ 基础清洗（v1）                                                    │
  │   canonicalize_hourly_bars → bars_hourly_{market}_{year}Q{q}    │
  └─────────────────────────────────────────────────────────────────┘
        ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │ 工业级清洗（v2 + Gold，可选，依赖 exchange_calendars）             │
  │   canonicalize_hourly_bars_v2 → bars_hourly_v2_*                 │
  │   + 复权因子（adj_factors_daily_*）                               │
  │   + build_gold_clean_bars → bars_hourly_clean_*                  │
  └─────────────────────────────────────────────────────────────────┘
```

- **美国**：yfinance 拉取 1 小时 K 线（免费约 60 天），按季度存入原始表与 v1 清洗表；若开启 v2/Gold，再写 v2 表、复权因子表与 Gold 表。
- **中国**：AKShare 东财 60 分钟（约 90 天），失败时用新浪备用源；同样按季度存 raw 与 v1；可选写 v2/Gold。

下面分三块说明：**数据源层标准化**、**基础清洗（v1）**、**工业级清洗（v2 + Gold）**与**入库方式**。

---

## 二、数据源层：原始数据标准化（Adapter 层）

不同 API 返回的列名、时间含义不一致，在进入统一清洗前先做**列名与结构**的标准化，保证都变成同一套列：`datetime, open, high, low, close, volume, amount?, adj_close?, dividend`。

### 2.1 美国（yfinance）

- **列名**：yfinance 返回 `Open/High/Low/Close/Volume`（单标的时可能带 MultiIndex），统一为小写 `open/high/low/close/volume`，`Adj Close` → `adj_close`。
- **时间**：索引为 bar 的**开始时间**，且为 UTC（或 naive 按 UTC 用）。重置索引后改名为 `datetime`。
- **复权与分红**：若无 `adj_close` 用 `close` 填充；补 `dividend` 列（通常为 None）。
- **成交额**：yfinance 1h 不提供 `amount`，在后续清洗阶段用 `volume * close` 补。

代码位置：`sources/us_yfinance.py` 中 `_normalize_us()`。

### 2.2 中国（AKShare 东财）

- **列名**：中文列名映射为英文  
  `时间→datetime, 开盘→open, 收盘→close, 最高→high, 最低→low, 成交量→volume, 成交额→amount`。
- **时间**：东财 60 分钟接口给出的是 **bar 结束时间**，且为上海时区。
- **复权**：使用前复权（qfq）时，收盘价已是复权价，直接作为 `adj_close`；补 `dividend`。

代码位置：`sources/cn_akshare.py` 中 `_normalize_cn()`。

### 2.3 中国（新浪备用源）

- **列名**：`day` → `datetime`，其余已是 `open/high/low/close/volume`；无 `amount`，在清洗阶段不补（或可视为缺失）。
- **时间**：同样按 bar 时间处理，并在接口层按 `start_dt/end_dt` 做时间范围过滤。

代码位置：`sources/cn_akshare.py` 中 `CNAKShareSinaFallbackSource.fetch_hourly()`。

---

## 三、基础清洗（v1）：cleaning.py

所有市场在写入 **v1 清洗表**前，都经过 **`canonicalize_hourly_bars()`**，实现以 bar 结束时刻为基准、双时区、去重排序、基础校验。

### 3.1 时间语义统一：Bar 结束时间 + 双时区

- **问题**：美国 API 给的是 **bar_start**（UTC）；中国 API 给的是 **bar_end**（上海时间）。
- **做法**：用 `MarketTimeSpec.timestamp_kind` 区分：
  - `bar_start`：`dt_end = 原始 datetime + 1 小时`（固定 +1h，未按日历早收等细分）。
  - `bar_end`：`dt_end = 原始 datetime`。
- **统一主键**：以 bar 结束时刻的 UTC 时间戳 `ts_end_utc`（秒）作为主键之一。
- **双时区存储**：`dt_end_utc`（ISO 带 Z）、`dt_end_local`（交易所本地），`exchange_tz` 为美国 `America/New_York`、中国 `Asia/Shanghai`。

### 3.2 时间解析与无效行剔除

- 将 `datetime` 解析为 `pd.to_datetime(..., errors="coerce")`，解析失败变为 `NaT`。
- 丢弃 `_dt` 为空的整行。

### 3.3 数值列类型与缺失字段补全

- 对 `open, high, low, close, volume, amount, adj_close, dividend` 做 `pd.to_numeric(..., errors="coerce")`。
- `amount` 缺失时用 `volume * close` 补（美国常见）；`adj_close` 缺失用 `close` 填；`dividend` 缺失补 NA。

### 3.4 价格与 OHLC 约束校验（v1 核心质量）

只保留满足以下条件的行：

1. **价格为正**：`open, high, low, close` 均 > 0。  
2. **OHLC 逻辑一致**：`high >= max(open, close, low)` 且 `low <= min(open, close, high)`。

不满足的行在 v1 中被**整行剔除**，因此会出现「raw=248, cleaned_saved=244」等情况。

### 3.5 v1 输出 schema

| 字段 | 含义 |
|------|------|
| `symbol` | 标的代码 |
| `ts_end_utc` | bar 结束时刻的 UTC 时间戳（秒） |
| `dt_end_utc` | 同上，ISO 字符串（带 Z） |
| `dt_end_local` | 交易所本地结束时间 |
| `exchange_tz` | 交易所时区 |
| `interval` | 周期，如 `1h` |
| `open, high, low, close, volume, amount, adj_close, dividend` | 行情与衍生字段 |
| `source` | 数据源标识 |
| `updated_at_utc` | 本批数据写入时的 UTC 时间 |

### 3.6 去重与排序

- 按 `(symbol, ts_end_utc)` 去重，按 `ts_end_utc` 排序，保证幂等增量与时间有序。

---

## 四、工业级清洗（v2 + Gold）

在 v1 之上，若配置开启且依赖 `exchange_calendars` 可用，会额外跑 **v2 规范** 与 **Gold 干净表** 管线。

### 4.1 交易日历与 bucket 生成（trading_calendar.py）

- **作用**：用官方交易所日历（US: XNYS，CN: XSHG）生成每个交易日的**预期 intraday bucket**（起止时间为 UTC + 本地）。
- **效果**：
  - **美股最后半小时**：常规日最后一根 bucket 结束于 16:00 本地（非固定 +1h 导致的 16:30）。
  - **早收日**：如 13:00 收盘日，最后一根为 12:30–13:00。
  - **午休/DST**：中国午休、美国冬夏令时由日历正确反映。
- **依赖**：`exchange_calendars`；若未安装则降级为“工作日固定时段”并打告警，v2/Gold 可能被跳过。

### 4.2 Silver v2：calendar-aware 规范（cleaning.py）

- **函数**：`canonicalize_hourly_bars_v2()`。
- **与 v1 区别**：
  - 每根 bar 的 `(ts_start_utc, ts_end_utc)` 通过**对齐到日历生成的 bucket** 得到，而不是 US 固定 +1h。
  - **不删行**：价格/OHLC 异常不打删行，而是打 QC 标志：`flag_off_calendar`、`flag_any_null_price`、`flag_nonpositive_price`、`flag_ohlc_inconsistent`、`flag_volume_negative`。
- **输出表**：`bars_hourly_v2_{market}_{year}Q{q}`，主键仍为 `(symbol, ts_end_utc)`。

### 4.3 网格对齐与缺失/停盘打标（clean_pipeline.py）

- **输入**：v2 表数据（单 symbol）。
- **步骤**：
  - 用日历生成该时间范围内的**预期 bucket 网格**，与 v2 观测做 left join。
  - 交易日应有但无数据的 bucket：**占位**，并打标 `is_missing=1`、`missing_reason="vendor_gap"`。
  - 连续缺失且在当日中间：打 `suspected_halt=1`（推断停牌/停盘）。
  - 有 bar 但 volume=0 且价格平坦：`is_no_trade=1`。
- **目的**：训练时能区分“缺数”与“无交易”，避免隐式删行导致时间错位。

### 4.4 复权因子融合（corp_actions.py + adj_factors_daily_*）

- **US**：用 yfinance 日频 `Close` 与 `Adj Close` 计算每日 `adj_factor = AdjClose/Close`，写入 `adj_factors_daily_us`；Gold 层按 `trade_date` 对齐到小时 bar，生成 `open_adj, high_adj, low_adj, close_adj`。
- **CN**：可选双抓（不复权 + 前复权）算每日因子并落表；默认可用前复权价作 `close_adj`，因子表可选。
- **目的**：统一用复权价做收益与异常检测，避免分红/拆股导致的“跳变”被误判为异常。

### 4.5 跳变/异常打标与隔离（clean_pipeline.py）

- **检测**：基于复权价 `close_adj` 的 log-return，结合滚动中位数/MAD 的鲁棒阈值与绝对阈值；另对 OHLC 宽幅（如 (high-low)/close）打 `flag_range_unusual`。
- **打标**：无法用复权解释的跳变打 `flag_jump_unexplained`；复权日打 `flag_corp_action`。
- **隔离策略**：对 QC 失败或异常 bar，在 Gold 输出中将对应 OHLC/volume/adj 字段置为 NULL，并令后续 **feature_mask / label_mask** 为 0，训练时显式排除。

### 4.6 训练/标签可用性 mask（clean_pipeline.py）

- **feature_mask**：当前 bar 是否可作为特征使用（未缺失、未隔离、有有效 close_adj）。
- **label_mask_1 / label_mask_4 / label_mask_7**：当前 bar 在 horizon 1/4/7 根 bar 内是否均可作为标签使用（当前及未来若干 bar 均满足特征可用）。
- **目的**：训练与回测时按 mask 过滤，避免缺失/异常 bar 污染样本与标签。

### 4.7 Gold 表输出 schema（bars_hourly_clean_*）

在 v2 字段基础上，Gold 表还包含：

| 类型 | 字段示例 | 含义 |
|------|----------|------|
| 时间 | `trade_date` | 本地交易日 YYYY-MM-DD |
| 复权 | `adj_factor`, `open_adj`, `high_adj`, `low_adj`, `close_adj` | 复权因子与复权价 |
| 缺失/停盘 | `is_missing`, `missing_reason`, `suspected_halt`, `is_no_trade` | 占位与打标 |
| QC/异常 | `flag_off_calendar`, `flag_*_price`, `flag_ohlc_*`, `flag_jump_unexplained`, `flag_range_unusual`, `flag_corp_action` | 各类打标 |
| 训练 | `feature_mask`, `label_mask_1`, `label_mask_4`, `label_mask_7` | 特征/标签可用性 |

主键仍为 `(symbol, ts_end_utc)`；按季度分表 `bars_hourly_clean_{market}_{year}Q{q}`。

---

## 五、入库方式（storage 层）

### 5.1 原始表（可选）

- **表名**：`ohlcv_{market}_{year}Q{q}`。
- **依据**：原始 `datetime` 所在季度。
- **内容**：标准化后的原始列（无 amount 等扩展字段）。由 `WRITE_RAW_TABLES` 控制。

### 5.2 v1 清洗表（bars_hourly_*）

- **表名**：`bars_hourly_{market}_{year}Q{q}`。
- **依据**：按 `dt_end_local` 算季度。
- **主键**：`(symbol, ts_end_utc)`，`INSERT OR REPLACE` 幂等。
- **内容**：`canonicalize_hourly_bars()` 的完整输出。

### 5.3 v2 规范表（bars_hourly_v2_*）

- **表名**：`bars_hourly_v2_{market}_{year}Q{q}`。
- **依据**：同上，按 `dt_end_local` 分季度。
- **主键**：`(symbol, ts_end_utc)`。
- **内容**：v2 canonical 输出（含 ts_start_utc、各 `flag_*`）。由 `WRITE_V2_TABLES` 控制。

### 5.4 Gold 干净表（bars_hourly_clean_*）

- **表名**：`bars_hourly_clean_{market}_{year}Q{q}`。
- **依据**：同上。
- **主键**：`(symbol, ts_end_utc)`。
- **内容**：网格对齐、缺失占位、复权价、异常隔离、mask。由 `WRITE_GOLD_TABLES` 控制。

### 5.5 复权因子表（adj_factors_daily_*）

- **表名**：`adj_factors_daily_us` / `adj_factors_daily_cn`。
- **主键**：`(symbol, trade_date)`。
- **内容**：`trade_date`（本地 YYYY-MM-DD）、`adj_factor`、source、updated_at_utc。

增量拉取时，v1/v2 均用 `get_last_ts_end_utc()` 查最大 `ts_end_utc`，带 `RESUME_OVERLAP` 重叠区间做幂等覆盖。

---

## 六、小结表：下载后做了哪些处理

| 阶段 | 做了什么 | 目的 |
|------|----------|------|
| 数据源适配 | 列名统一为 datetime/OHLCV/amount/adj_close/dividend | 多源入同一套清洗逻辑 |
| **v1 时间** | 区分 bar_start/bar_end，统一为 bar 结束时刻；ts_end_utc、双时区 | 跨市场对齐、去重、排序 |
| **v1 校验** | 价格>0；high/low 包住 open/close；不满足则删行 | 剔除明显异常 bar |
| **v2 日历** | 用交易所日历生成 bucket，对齐 ts_start/ts_end（早收/午休/DST） | 美股最后半小时、早收日正确 |
| **v2 打标** | 异常不打删行，打 flag_* | 可审计、可下游隔离 |
| **Gold 网格** | 日历网格 + 缺失占位 + is_missing/suspected_halt/is_no_trade | 区分缺数与无交易 |
| **Gold 复权** | adj_factor 表 + *_adj 列 | 收益与异常检测用复权价 |
| **Gold 异常** | 跳变/宽幅打标 + 隔离（NULL + mask=0） | 防止坏点进入训练 |
| **Gold mask** | feature_mask、label_mask_1/4/7 | 训练/标签可用性显式化 |
| 分表入库 | raw / v1 / v2 / clean / adj_factors 按需分表 | 按季度查询、增量更新、可追溯 |

整体上，**下载后的数据处理**分为：**数据源标准化 → v1 基础清洗（双时区 + 校验删行）→ 可选 v2 规范（日历对齐 + 打标不删行）→ 可选 Gold 干净表（网格 + 缺失占位 + 复权 + 异常隔离 + mask）**，满足从“可对齐”到“可训练”的工业级需求。
