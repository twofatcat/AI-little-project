# TimeSeriesProject 终端命令速查

所有命令均在项目根目录执行：`cd /home/linux_system/TimeSeriesProject`

---

## 1. 环境准备（首次或换环境）

```bash
cd /home/linux_system/TimeSeriesProject
pip install -r requirements.txt
```

依赖包含：`pandas`、`yfinance`、`akshare`、`exchange_calendars`（交易日历，用于 v2/Gold 清洗）。若未安装 `exchange_calendars`，v2/Gold 会跳过并打日志告警，v1 抓取与 `bars_hourly_*` 仍正常。

---

## 2. 抓取数据（主流程）

```bash
# 抓取 US + CN（默认）
python main.py

# 只抓 US
python main.py --market us

# 只抓 CN
python main.py --market cn
```

每次运行会从上次保存进度续跑，拉到当前最新。数据按季度写入 `data/stocks.db`：

- **Raw**：`ohlcv_{market}_{year}Q{q}`（可选，由 `WRITE_RAW_TABLES` 控制）
- **v1 清洗**：`bars_hourly_{market}_{year}Q{q}`
- **v2 规范**（日历对齐 + QC 打标）：`bars_hourly_v2_{market}_{year}Q{q}`（由 `WRITE_V2_TABLES` 控制）
- **Gold 干净表**（网格 + 缺失占位 + 复权 + 异常隔离 + mask）：`bars_hourly_clean_{market}_{year}Q{q}`（由 `WRITE_GOLD_TABLES` 控制）
- **复权因子**：`adj_factors_daily_{market}`（US 默认拉日频算因子）

---

## 3. 查看数据

```bash
# 总览：各表行数 + 每市场最新表前 5 条
python view_data.py

# 每表多显示几行
python view_data.py --head 20

# 只看某只股票
python view_data.py --symbol AAPL
python view_data.py --symbol 300124 --market cn

# 只看某张季度表（v1 / v2 / Gold 表名不同）
python view_data.py --table ohlcv_us_2026Q1
python view_data.py --table bars_hourly_cn_2026Q1 --head 5
python view_data.py --table bars_hourly_v2_us_2026Q1 --head 5
python view_data.py --table bars_hourly_clean_cn_2026Q1 --head 5
```

---

## 4. 质量报告（bars 表：v1 / v2 / clean）

```bash
# 所有市场的 bars* 表（含 v1、v2、clean）
python quality_report.py

# 只看 US
python quality_report.py --market us

# 只看 CN
python quality_report.py --market cn
```

会输出每表行数、symbol 数、时间范围、每 symbol 条数；**每天 bar 数**按**交易所日历**计算预期（早收/节假日正确），并标出与预期不符的天数。对 Gold 表（`bars_hourly_clean_*`）还会输出缺失占位统计。

---

## 5. 迁移旧数据

### 5.1 旧格式 → v1 清洗表（bars_hourly_*）

```bash
# 把现有 ohlcv_* 转成 v1 清洗表（不重新抓）
python migrate_ohlcv_to_bars.py

# 只迁移 CN / US
python migrate_ohlcv_to_bars.py --market cn
python migrate_ohlcv_to_bars.py --market us
```

### 5.2 从 raw 重建 v2 + Gold（工业级表）

```bash
# 从 ohlcv_* 重建 bars_hourly_v2_* 与 bars_hourly_clean_*
python migrate_to_v2_clean.py

# 只重建 US / CN
python migrate_to_v2_clean.py --market us
python migrate_to_v2_clean.py --market cn

# 离线：不拉 US 日频复权因子
python migrate_to_v2_clean.py --no-us-factor-fetch

# 带抽样校验（收盘时刻、缺失占位、异常隔离）
python migrate_to_v2_clean.py --market us --verify
```

---

## 6. 直接用 SQLite 查库（可选）

```bash
sqlite3 data/stocks.db
```

进入后例如：

```sql
.tables
SELECT count(*) FROM ohlcv_us_2026Q1;
SELECT * FROM bars_hourly_cn_2026Q1 LIMIT 5;
SELECT count(*) FROM bars_hourly_clean_us_2026Q1;
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'bars%' ORDER BY name;
.quit
```

---

## 常用流程示例

**首次使用：安装 → 全市场抓取 → 看数据 → 看质量**

```bash
cd /home/linux_system/TimeSeriesProject
pip install -r requirements.txt
python main.py
python view_data.py
python quality_report.py
```

**日常增量：只抓 CN → 看 CN 质量**

```bash
cd /home/linux_system/TimeSeriesProject
python main.py --market cn
python quality_report.py --market cn
```

**已有 ohlcv_*、要补齐 v2/Gold：迁移并校验**

```bash
python migrate_to_v2_clean.py --market us --verify
python migrate_to_v2_clean.py --market cn
python quality_report.py
```
